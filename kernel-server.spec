#
# Spec file generated by kdist version v0.0.4-57-g3d97
#
Name:          kernel-server
Summary:       The Linux Kernel for Mandriva systems
License:       GPLv2
Version:       3.1.5
Release:       %mkrel 1.1
URL:           http://www.kernel.org
Source:        kernel-server-3.1.5-1.tar.bz2
ExclusiveArch: x86_64 
BuildRoot:     %{_tmppath}/%{name}-%{version}-root

%global __debug_package 1
%define debug_package %{nil}
%define __check_files %{nil}

%ifarch %ix86 x86_64
%define asmarch x86
%define bzImage arch/x86/boot/bzImage
%define instkern_opts %{nil}
%endif

%ifarch %arm
%define asmarch arm
%define bzImage arch/arm/boot/zImage
%define instkern_opts -i -N
%endif

Summary:       The Linux Kernel for Mandriva systems
Provides:      kernel = %{version}-%{release}
Group:         System/Kernel and hardware
Requires:      kernel-firmware

%description
The Linux Kernel, the operating system core itself

%package devel
Summary:       The minimal Linux Kernel for building kernel modules
Provides:      kernel-devel = %{version}-%{release}
Group:         Development/Kernel
AutoReqProv:   no
BuildRequires: rsync

%description -n kernel-server-devel
This package provides kernel headers, makefiles and a couple
of others files sufficient to build external kernel modules.

%package debuginfo
Summary:       The debug information for kernel-server
Provides:      kernel-debuginfo = %{version}-%{release}
AutoReqProv:   no
Group:         Development/Debug

%description -n kernel-server-debuginfo
This package provides the kernel's debug information required
by some binary object tools like kgdb, perf, etc...

%prep
%setup -q -n kernel-server-3.1.5-1

%build
make defconfig
make -s kernelrelease
test $(make -s kernelrelease) = 3.1.5-1.1-server
make %{?_smp_mflags}

%install
make -s INSTALL_MOD_PATH=%{buildroot} modules_install
find %{buildroot} -name \*.ko -exec chmod u+x {} \;

mkdir -p %{buildroot}/boot
cp %{bzImage} %{buildroot}/boot/vmlinuz-3.1.5-1.1-server
cp System.map %{buildroot}/boot/System.map-3.1.5-1.1-server
cp .config    %{buildroot}/boot/config-3.1.5-1.1-server
ln -snf /usr/src/devel/3.1.5-1.1-server %{buildroot}/lib/modules/3.1.5-1.1-server/build
ln -snf build %{buildroot}/lib/modules/3.1.5-1.1-server/source

mkdir -p %{buildroot}/usr/src/devel/3.1.5-1.1-server
cat develfiles-%asmarch.list >>develfiles.list
rsync -ar --files-from=develfiles.list . %{buildroot}/usr/src/devel/3.1.5-1.1-server

%post -n kernel-server
/sbin/installkernel %{instkern_opts} 3.1.5-1.1-server

%preun -n kernel-server
/sbin/installkernel -R 3.1.5-1.1-server

%postun -n kernel-server
/sbin/kernel_remove_initrd 3.1.5-1.1-server

%clean
rm -rf %{buildroot}

%files -n kernel-server
%defattr (-, root, root)
%dir /lib/modules
/lib/modules/3.1.5-1.1-server
/boot

%files -n kernel-server-devel
%defattr (-, root, root)
/usr/src/devel/3.1.5-1.1-server

%files -n kernel-server-debuginfo -f debugfiles.list
%defattr (-, root, root)

%changelog
* Sat Dec 10 2011 Franck Bui <franck.bui@mandriva.com> 3.1.5-1.1-server
  + Mandriva Release v3.1.5-1
  + pci: Rework ASPM disable code
  + usb: ehci: make HC see up-to-date qh/qtd descriptor ASAP
  + btrfs: btrfs_calc_avail_data_space cope with no read/write devices V2
  + gpu drm mach64 2.6.39 buildfix
  + vfs: introduce clone_private_mount()
  + vfs: export do_splice_direct() to modules
  + vfs: add i_op->open()
  + Mandriva Linux boot logo.
  + media video pwc no ads in dmesg
  + media video pwc lie in proc usb devices
  + usb storage unusual_devs add id 2.6.37 buildfix
  + Change to usb storage of unusual_dev.
  + Add blacklist of usb hid modules
  + bluetooth hci_usb disable isoc transfers
  + sound alsa hda ad1884a hp dc model
  + Support a Bluetooth SCO.
  + include kbuild export pci_ids
  + platform x86 add shuttle wmi driver
  + net netfilter psd 2.6.35 buildfix
  + ipt_psd: Mandriva changes
  + net netfilter psd
  + net netfilter IFWLOG 2.6.37 buildfix
  + net netfilter IFWLOG 2.6.35 buildfix
  + net netfilter IFWLOG mdv
  + net netfilter IFWLOG
  + net sis190 fix list usage
  + kbuild compress kernel modules on installation
  + gpu drm mach64 2.6.37 buildfix
  + gpu drm mach64 2.6.36 buildfix
  + gpu drm mach64 fix for changed drm_ioctl
  + gpu drm mach64 fix for changed drm_pci_alloc
  + Adapt mach64 to build with 2.6.31 series kernels
  + gpu drm mach64 fixes
  + gpu drm mach64
  + agp/intel: add new host bridge id for Q57 system
  + mpt scsi modules for VMWare's emulated
  + ide pci sis5513 965
  + ppscsi: build fix for 2.6.39
  + scsi megaraid new sysfs name
  + scsi ppscsi mdvbz45393
  + scsi ppscsi update for scsi_data_buffer
  + scsi ppscsi sg helper update
  + scsi ppscsi_fixes
  + scsi ppscsi-2.6.2
  + acpi video add blacklist to use vendor driver
  + acpi processor M720SR limit to C2
  + CLEVO M360S acpi irq workaround
  + acpi add proc event regs
  + acpi dsdt initrd v0.9c fixes
  + acpi dsdt initrd v0.9c 2.6.28
  + UBUNTU: SAUCE: isapnp_init: make isa PNP scans occur async
  + pnp pnpbios off by default
  + pci add ALI M5229 ide compatibility mode quirk
  + Card bus's PCI last bus
  + x86, cpufreq: set reasonable default for scaling_min_freq with p4-clockmod
  + x86 cpufreq speedstep dothan 3
  + default to "power_off" when SMP kernel is used on single processo
  + x86 boot video 80x25 if break
  + x86 pci toshiba equium a60 assign busses
  + kdist: make the config name part of the localversion
  + kdist: give a name to the config file
